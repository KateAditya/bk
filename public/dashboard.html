<!DOCTYPE html>
<html>

<head>
    <title>Product Dashboard</title>
    <link rel="stylesheet" href="admin.css">
</head>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

    body {
        font-family: 'Poppins', sans-serif;
        background-size: 200% 200%;
        animation: glacierShine 5s infinite alternate ease-in-out;
        padding: 20px;
        margin: 0;
    }

    h1,
    h2 {
        text-align: center;
        margin: 1rem 0;
        color: #4e4e8a;
    }

    /* Product Form */
    form#addProductForm {
        max-width: 600px;
        margin: 1rem auto;
        background: rgba(202, 189, 221, 0.3);
        padding: 20px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 20px rgba(44, 49, 88, 0.3);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    form#addProductForm input[type="text"],
    form#addProductForm input[type="number"],
    form#addProductForm input[type="url"],
    form#addProductForm select,
    form#addProductForm input[type="file"] {
        padding: 10px;
        font-size: 1rem;
        border-radius: 6px;
        border: 1px solid #b197bc;
        font-family: 'Poppins', sans-serif;
    }

    /* Form Section */
    .form-section {
        background: rgba(255, 255, 255, 0.2);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
    }

    .form-section h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #4e4e8a;
        font-size: 1.1rem;
    }

    /* Image Preview */
    .image-preview-container {
        margin-top: 10px;
        text-align: center;
    }

    .image-preview {
        max-width: 300px;
        max-height: 200px;
        border-radius: 8px;
        border: 2px solid #b197bc;
        display: none;
        margin: 10px auto;
    }

    .preview-placeholder {
        display: block;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px dashed #b197bc;
        border-radius: 8px;
        color: #4e4e8a;
        font-style: italic;
        margin: 10px 0;
    }

    .preview-loading {
        display: none;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #b197bc;
        border-radius: 8px;
        color: #4e4e8a;
        margin: 10px 0;
    }

    .preview-error {
        color: #ff4444 !important;
        background: rgba(255, 68, 68, 0.1) !important;
        border-color: #ff4444 !important;
    }

    .preview-success {
        color: #4CAF50 !important;
        background: rgba(76, 175, 80, 0.1) !important;
        border-color: #4CAF50 !important;
    }

    /* URL Helper Text */
    .url-helper {
        font-size: 0.8rem;
        color: #666;
        margin-top: 5px;
        font-style: italic;
    }

    /* Upload Progress */
    .upload-progress {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
        margin: 10px 0;
        overflow: hidden;
        display: none;
    }

    .upload-progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #b197bc, #2c3158);
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
    }

    /* Buttons */
    button {
        cursor: pointer;
        padding: 12px;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        background: linear-gradient(135deg, #b197bc, #2c3158);
        color: white;
        font-family: 'Poppins', sans-serif;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button#cancelEdit {
        background: linear-gradient(135deg, #97a5bc, #2c3e58);
    }

    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    /* Product List */
    #productList {
        max-width: 1200px;
        margin: 20px auto;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
    }

    /* Product Item */
    .item {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(202, 189, 221, 0.5));
        border-radius: 10px;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        padding: 15px;
    }

    .item:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
    }

    .item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .item-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .item h3 {
        font-size: 1.2rem;
        color: #333;
        margin-bottom: 5px;
        font-weight: 600;
    }

    .discount {
        display: inline-block;
        font-size: 0.9rem;
        color: #555;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .prices {
        font-size: 1.3rem;
        color: #fc0000;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .download-link {
        font-size: 0.85rem;
        color: #4e4e8a;
        margin-bottom: 10px;
        word-break: break-word;
    }

    .download-link strong {
        display: block;
        margin-bottom: 3px;
    }

    /* Product Actions */
    .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: auto;
    }

    .actions button,
    .actions input.buy-btn {
        padding: 8px;
        font-size: 0.9rem;
        font-weight: 600;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        color: #ffffff;
        background-color: #b197bc;
        transition: all 0.3s ease;
        text-align: center;
    }

    .actions button:hover,
    .actions input.buy-btn:hover {
        background-color: #9a81a6;
    }

    .actions button.view {
        background-color: #5c5c8a;
    }

    .actions button.edit {
        background-color: #5c8a5c;
    }

    .actions button.delete {
        background-color: #8a5c5c;
    }

    /* Toast Notification */
    #toast {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        background: #4CAF50;
        color: white;
        border-radius: 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1000;
        max-width: 300px;
        word-wrap: break-word;
    }

    #toast.show {
        opacity: 1;
    }

    #toast.error {
        background: #f44336;
    }

    /* Logout Button */
    .logout-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .logout-btn {
        background: linear-gradient(135deg, #bc9797, #582c2c) !important;
        padding: 10px 20px !important;
        font-size: 0.9rem !important;
        white-space: nowrap;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        form#addProductForm {
            max-width: 90%;
        }

        #productList {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .logout-container {
            position: absolute;
        }
    }

    @media (max-width: 480px) {
        #productList {
            grid-template-columns: 1fr;
        }

        .actions {
            grid-template-columns: 1fr;
        }

        .logout-container {
            top: 10px;
            right: 10px;
        }

        .logout-btn {
            padding: 8px 15px !important;
            font-size: 0.8rem !important;
        }
    }

    /* Add these styles for disabled button */
    button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
    }

    /* Image loading placeholder */
    .image-loading {
        width: 100%;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        border-radius: 8px;
        color: #666;
        font-style: italic;
    }

    /* File drop zone */
    .file-drop-zone {
        border: 2px dashed #b197bc;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 10px;
    }

    .file-drop-zone:hover,
    .file-drop-zone.dragover {
        border-color: #4e4e8a;
        background: rgba(255, 255, 255, 0.2);
    }

    .file-drop-zone.dragover {
        transform: scale(1.02);
    }

    .file-input {
        display: none;
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
</style>

<body>
    <div style="position: fixed; top: 20px; right: 20px;">
        <button onclick="logout()" style="background: linear-gradient(135deg, #bc9797, #582c2c);">Logout</button>
    </div>

    <h1>Integrated Product Dashboard</h1>

    <form id="addProductForm" enctype="multipart/form-data">
        <input type="hidden" name="id" id="productId">
        <input type="hidden" name="image_url" id="imageUrl">

        <div class="form-section">
            <h3>Product Details</h3>
            <input type="text" name="title" id="title" placeholder="Product Title" required>
            <input type="text" name="discount" id="discount" placeholder="Discount" required>
            <input type="number" name="price" id="price" placeholder="Price" required>
            <input type="text" name="description" id="description" placeholder="Description" required>
            <input type="text" name="view_link" id="viewLink" placeholder="View Link">
        </div>

        <div class="form-section">
            <h3>📁 Upload Product Image</h3>

            <div class="file-drop-zone" id="fileDropZone">
                <div>
                    <strong>📸 Click to upload or drag & drop image here</strong>
                    <br>
                    <small>Supported formats: JPG, PNG, GIF (Max 10MB)</small>
                </div>
            </div>

            <label for="imageUpload" class="sr-only">Upload Product Image</label>
            <input type="file" id="imageUpload" class="file-input" accept="image/*" aria-label="Upload product image file">

            <div class="upload-progress" id="uploadProgress">
                <div class="upload-progress-bar" id="uploadProgressBar"></div>
            </div>

            <div class="image-preview-container">
                <div class="preview-placeholder" id="previewPlaceholder">
                    Upload an image to see preview
                </div>
                <div class="preview-loading" id="previewLoading">
                    Uploading image to GitHub...
                </div>
                <img class="image-preview" id="imagePreview" alt="Image Preview">
            </div>
        </div>

        <div class="button-group">
            <button type="submit" id="saveButton">Save Product</button>
            <button type="button" id="cancelEdit" style="display:none;">Cancel Edit</button>
        </div>
    </form>

    <a href="admin.html"><button>Add Data Link</button></a>

    <h2>Product List</h2>
    <div id="productList"></div>

    <div id="toast"></div>
    <script>
        function logout() {
            fetch(`/api/logout`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/login.html';
                    } else {
                        alert(data.message || 'Logout failed');
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Logout failed: ' + err.message);
                });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("addProductForm");
            const productList = document.getElementById("productList");
            const productIdInput = document.getElementById("productId");
            const cancelEditBtn = document.getElementById("cancelEdit");
            const imageUpload = document.getElementById("imageUpload");
            const imageUrl = document.getElementById("imageUrl");
            const imagePreview = document.getElementById("imagePreview");
            const previewPlaceholder = document.getElementById("previewPlaceholder");
            const previewLoading = document.getElementById("previewLoading");
            const fileDropZone = document.getElementById("fileDropZone");
            const uploadProgress = document.getElementById("uploadProgress");
            const uploadProgressBar = document.getElementById("uploadProgressBar");

            let currentImageUrl = '';

            // Function to toggle image requirement based on edit mode
            function setImageRequirement(isEditing) {
                if (isEditing) {
                    imageUpload.removeAttribute('required');
                } else {
                    imageUpload.setAttribute('required', '');
                }
            }

            // Initialize image as required for new products by default
            setImageRequirement(false);

            // File drop zone functionality
            fileDropZone.addEventListener('click', () => {
                imageUpload.click();
            });

            fileDropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDropZone.classList.add('dragover');
            });

            fileDropZone.addEventListener('dragleave', () => {
                fileDropZone.classList.remove('dragover');
            });

            fileDropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload(files[0]);
                }
            });

            // Image upload handler
            imageUpload.addEventListener('change', function () {
                const file = this.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            async function handleFileUpload(file) {
                // Validate file
                if (!file.type.match('image.*')) {
                    showError('Please select an image file (JPG, PNG, GIF)');
                    return;
                }

                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showError('Image size must be less than 10MB');
                    return;
                }

                // Show preview before upload
                const previewUrl = URL.createObjectURL(file);
                showPreview(previewUrl);

                try {
                    showLoading();
                    showProgress(0);

                    // Create FormData for file upload
                    const formData = new FormData();
                    formData.append('image', file);

                    // Upload to our backend API (which will handle GitHub upload)
                    const response = await fetch('/api/upload-image', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed');
                    }

                    const result = await response.json();

                    // Store the GitHub URL
                    currentImageUrl = result.imageUrl;
                    imageUrl.value = currentImageUrl;

                    showProgress(100);

                    // Update preview with GitHub URL
                    setTimeout(() => {
                        showPreview(currentImageUrl);
                        showSuccessMessage('Image uploaded successfully! ✅');
                        hideProgress();
                    }, 500);

                } catch (err) {
                    console.error('Upload error:', err);
                    showError(`Upload failed: ${err.message}`);
                    hideProgress();
                }
            }

            function resetPreview() {
                imagePreview.style.display = 'none';
                previewLoading.style.display = 'none';
                previewPlaceholder.style.display = 'block';
                previewPlaceholder.textContent = 'Upload an image to see preview';
                previewPlaceholder.className = 'preview-placeholder';
                imageUpload.value = '';
                currentImageUrl = '';
                imageUrl.value = '';
                hideProgress();
            }

            function showLoading() {
                imagePreview.style.display = 'none';
                previewPlaceholder.style.display = 'none';
                previewLoading.style.display = 'block';
            }

            function showPreview(url) {
                previewLoading.style.display = 'none';
                previewPlaceholder.style.display = 'none';
                imagePreview.src = url;
                imagePreview.style.display = 'block';
            }

            function showError(message) {
                previewLoading.style.display = 'none';
                imagePreview.style.display = 'none';
                previewPlaceholder.style.display = 'block';
                previewPlaceholder.textContent = message;
                previewPlaceholder.className = 'preview-placeholder preview-error';
                imageUpload.value = '';
                showToast(message, true);
            }

            function showSuccessMessage(message) {
                previewLoading.style.display = 'none';
                previewPlaceholder.style.display = 'block';
                previewPlaceholder.textContent = message;
                previewPlaceholder.className = 'preview-placeholder preview-success';

                setTimeout(() => {
                    previewPlaceholder.style.display = 'none';
                }, 2000);
            }

            function showProgress(percent) {
                uploadProgress.style.display = 'block';
                uploadProgressBar.style.width = percent + '%';
            }

            function hideProgress() {
                uploadProgress.style.display = 'none';
                uploadProgressBar.style.width = '0%';
            }

            function showToast(message, isError = false) {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = isError ? 'toast error' : 'toast';
                toast.classList.add('show');

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 4000);
            }

            form.addEventListener("submit", async function (e) {
                e.preventDefault();
                const saveButton = document.getElementById('saveButton');
                const originalButtonText = saveButton.textContent;

                try {
                    saveButton.textContent = 'Saving...';
                    saveButton.disabled = true;

                    const id = productIdInput.value;
                    
                    // Validate image upload only for new products
                    if (!id && !currentImageUrl) {
                        throw new Error('Please upload an image first');
                    }
                    const formData = new FormData(this);

                    // Get the working image URL
                    formData.set('image_url', currentImageUrl);

                    const url = id ? `/api/products/${id}` : `/api/products`;
                    const method = id ? 'PUT' : 'POST';

                    const jsonData = {};
                    formData.forEach((value, key) => {
                        jsonData[key] = value;
                    });

                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(jsonData)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const data = await response.json();
                    showToast(id ? "✅ Product updated successfully!" : "✅ Product added successfully!");

                    // Reset form
                    form.reset();
                    resetPreview();

                    if (id) {
                        productIdInput.value = '';
                        cancelEditBtn.style.display = 'none';
                        // Set image as required for new products
                        setImageRequirement(false);
                    }

                    loadProducts();
                } catch (err) {
                    console.error('Error saving product:', err);
                    showToast(`❌ Failed to ${productIdInput.value ? 'update' : 'add'} product: ${err.message}`, true);
                } finally {
                    saveButton.textContent = originalButtonText;
                    saveButton.disabled = false;
                }
            });

            cancelEditBtn.addEventListener("click", () => {
                form.reset();
                productIdInput.value = '';
                cancelEditBtn.style.display = 'none';
                resetPreview();
                // Set image as required for new products
                imageUpload.setAttribute('required', '');
            });

            // Function to create image element with better error handling
            function createImageElement(product) {
                const imgContainer = document.createElement('div');
                imgContainer.style.position = 'relative';

                const img = document.createElement('img');
                img.style.width = '100%';
                img.style.height = '200px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '8px';
                img.style.marginBottom = '10px';
                img.style.border = '1px solid rgba(0, 0, 0, 0.1)';
                img.alt = product.title;

                // Loading placeholder
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'image-loading';
                loadingDiv.textContent = 'Loading image...';

                imgContainer.appendChild(loadingDiv);
                imgContainer.appendChild(img);

                // Try to load image with fallback
                if (product.image_url) {
                    img.src = product.image_url;
                    img.onload = () => {
                        loadingDiv.style.display = 'none';
                        img.style.display = 'block';
                    };
                    img.onerror = () => {
                        // Try adding cache busting parameter
                        if (!img.src.includes('?')) {
                            img.src = product.image_url + '?t=' + Date.now();
                        } else {
                            loadingDiv.textContent = 'Failed to load image';
                            loadingDiv.style.color = '#ff4444';
                        }
                    };
                } else {
                    loadingDiv.textContent = 'No image available';
                    loadingDiv.style.color = '#666';
                }

                return imgContainer;
            }

            function loadProducts() {
                productList.innerHTML = '<div>Loading products...</div>';

                fetch("/api/products", {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                })
                    .then(async response => {
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(products => {
                        if (!Array.isArray(products)) throw new Error('Invalid data format received');

                        if (products.length === 0) {
                            productList.innerHTML = '<div>No products found</div>';
                            return;
                        }

                        productList.innerHTML = '';
                        products.forEach(p => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'item';
                            itemDiv.setAttribute('data-id', p.id);

                            // Create image
                            const imgContainer = createImageElement(p);

                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'item-content';
                            contentDiv.innerHTML = `
                                <h3>${p.title}</h3>
                                <span class="discount">${p.discount}</span>
                                <p class="prices">₹${p.price}</p>
                                <div class="actions">
                                    <form class="pay-form" style="display:inline;">
                                        <input type="hidden" name="name" value="${p.title}">
                                        <input type="hidden" name="amount" value="${p.price}">
                                        <input type="hidden" name="description" value="${p.description}">
                                        <input type="submit" class="buy-btn" value="Buy Now">
                                    </form>
                                    <button class="view" onclick="window.open('${p.view_link}')">View</button>
                                    <button class="edit" onclick="editProduct(${p.id})">Edit</button>
                                    <button class="delete" onclick="deleteProduct(${p.id})">Delete</button>
                                </div>
                            `;

                            itemDiv.appendChild(imgContainer);
                            itemDiv.appendChild(contentDiv);
                            productList.appendChild(itemDiv);
                        });
                    })
                    .catch(err => {
                        console.error('Error loading products:', err);
                        productList.innerHTML = `
                    <div class="error-message">
                        Failed to load products. ${err.message}
                        <button onclick="loadProducts()">Try Again</button>
                    </div>`;
                    });
            }

            function editProduct(id) {
                fetch(`/api/products/${id}`, {
                    credentials: 'include'
                })
                    .then(res => {
                        if (!res.ok) {
                            if (res.status === 401) {
                                window.location.href = '/login.html?redirect=/dashboard.html';
                                throw new Error('Not authenticated');
                            }
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(p => {
                        if (!p) {
                            alert("Product not found");
                            return;
                        }

                        productIdInput.value = p.id;
                        form.title.value = p.title;
                        form.discount.value = p.discount;
                        form.price.value = p.price;
                        form.description.value = p.description;
                        form.view_link.value = p.view_link;
                        imageUrl.value = p.image_url;
                        currentImageUrl = p.image_url;

                        // Show existing image
                        if (p.image_url) {
                            showPreview(p.image_url);
                        } else {
                            resetPreview();
                        }

                        cancelEditBtn.style.display = 'inline';
                        // Remove image requirement when editing
                        setImageRequirement(true);
                        window.scrollTo(0, 0);
                    })
                    .catch(err => {
                        console.error('Error editing product:', err);
                        if (err.message !== 'Not authenticated') {
                            alert('Failed to edit product: ' + err.message);
                        }
                    });
            }

            function deleteProduct(id) {
                if (!confirm("Are you sure you want to delete this product?")) return;

                fetch(`/api/products/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                })
                    .then(res => {
                        if (!res.ok) {
                            if (res.status === 401) {
                                window.location.href = '/login.html?redirect=/dashboard.html';
                                throw new Error('Not authenticated');
                            }
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        showToast(data.message);
                        loadProducts();
                    })
                    .catch(err => {
                        console.error('Error deleting product:', err);
                        if (err.message !== 'Not authenticated') {
                            showToast('Failed to delete product: ' + err.message, true);
                        }
                    });
            }

            // Initialize
            loadProducts();
            window.editProduct = editProduct;
            window.deleteProduct = deleteProduct;
        });
    </script>

</body>
<script src="logout.js"></script>

</html>